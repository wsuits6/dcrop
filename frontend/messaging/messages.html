<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - DCROP</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <div class="page-container">
        <!-- Header -->
        <header class="page-header">
            <div class="header-content">
                <h1>‚úâÔ∏è Messages</h1>
                <p id="headerSubtitle">Communicate with your coordinator</p>
            </div>
            <button class="btn btn-outline" onclick="goBack()">‚Üê Back to Dashboard</button>
        </header>

        <!-- Main Content -->
        <main class="page-content">
            <!-- User Info Card -->
            <div class="user-info-banner">
                <div class="user-details">
                    <h3 id="userName">Loading...</h3>
                    <p id="userRole">-</p>
                </div>
                <div class="message-stats">
                    <div class="stat-item">
                        <span class="stat-number" id="totalMessages">0</span>
                        <span class="stat-label">Total Messages</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="unreadMessages">0</span>
                        <span class="stat-label">Unread</span>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="message-actions">
                <button class="btn btn-primary" id="newMessageBtn">
                    ‚úâÔ∏è New Message
                </button>
                <button class="btn btn-outline" id="refreshBtn">
                    üîÑ Refresh
                </button>
                <button class="btn btn-outline" id="markAllReadBtn">
                    ‚úì Mark All as Read
                </button>
            </div>

            <!-- New Message Form (Hidden by default) -->
            <div id="newMessageForm" class="message-form-card hidden">
                <div class="form-header">
                    <h3>üìù Compose New Message</h3>
                    <button class="btn-close" id="closeFormBtn">‚úï</button>
                </div>

                <form id="sendMessageForm">
                    <!-- Recipient (Dynamic based on role) -->
                    <div class="form-group" id="recipientGroup">
                        <label for="recipient">Send To:</label>
                        <select id="recipient" name="recipient" required>
                            <option value="">-- Select Recipient --</option>
                        </select>
                    </div>

                    <!-- Subject (Optional) -->
                    <div class="form-group">
                        <label for="messageSubject">Subject: (Optional)</label>
                        <input 
                            type="text" 
                            id="messageSubject" 
                            placeholder="Enter message subject"
                            maxlength="100"
                        >
                    </div>

                    <!-- Message Content -->
                    <div class="form-group">
                        <label for="messageContent">Message: <span class="required">*</span></label>
                        <textarea 
                            id="messageContent" 
                            name="message" 
                            rows="6" 
                            required 
                            placeholder="Type your message here..."
                            maxlength="1000"
                        ></textarea>
                        <small class="char-count">
                            <span id="charCount">0</span>/1000 characters
                        </small>
                    </div>

                    <!-- Form Actions -->
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <span class="btn-text">üì§ Send Message</span>
                            <span class="btn-loader hidden">Sending...</span>
                        </button>
                        <button type="button" class="btn btn-outline" id="cancelMessageBtn">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>

            <!-- Messages Display Section -->
            <div class="messages-section">
                <!-- Tabs -->
                <div class="message-tabs">
                    <button class="tab-btn active" data-tab="received">
                        üì• Received Messages
                    </button>
                    <button class="tab-btn" data-tab="sent">
                        üì§ Sent Messages
                    </button>
                </div>

                <!-- Received Messages Tab -->
                <div id="receivedTab" class="tab-content active">
                    <div class="messages-list" id="receivedMessagesList">
                        <div class="loading-state">
                            <div class="loader"></div>
                            <p>Loading messages...</p>
                        </div>
                    </div>
                </div>

                <!-- Sent Messages Tab -->
                <div id="sentTab" class="tab-content">
                    <div class="messages-list" id="sentMessagesList">
                        <div class="loading-state">
                            <div class="loader"></div>
                            <p>Loading sent messages...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <template id="emptyStateTemplate">
                <div class="empty-state">
                    <div class="empty-icon">üì≠</div>
                    <h3>No Messages Yet</h3>
                    <p>You haven't received any messages yet. Check back later!</p>
                </div>
            </template>

            <!-- Message Card Template -->
            <template id="messageCardTemplate">
                <div class="message-card">
                    <div class="message-header">
                        <div class="sender-info">
                            <span class="sender-icon">üë§</span>
                            <div class="sender-details">
                                <h4 class="sender-name">-</h4>
                                <p class="sender-role">-</p>
                            </div>
                        </div>
                        <div class="message-meta">
                            <span class="message-time">-</span>
                            <span class="message-status">-</span>
                        </div>
                    </div>
                    <div class="message-body">
                        <p class="message-text">-</p>
                    </div>
                    <div class="message-actions">
                        <button class="btn-sm btn-outline" onclick="replyMessage(this)">
                            ‚Ü©Ô∏è Reply
                        </button>
                        <button class="btn-sm btn-danger" onclick="deleteMessage(this)">
                            üóëÔ∏è Delete
                        </button>
                    </div>
                </div>
            </template>
        </main>
    </div>

    <script src="../js/main.js"></script>
    <script src="../js/messaging.js"></script>
    <script>
        let userData = null;
        let userRole = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            const user = JSON.parse(localStorage.getItem('user'));
            const role = localStorage.getItem('userRole');

            if (!user) {
                window.location.href = '../index.html';
                return;
            }

            userData = user;
            userRole = role;

            initializePage();
            loadMessages();

            // Event listeners
            document.getElementById('newMessageBtn').addEventListener('click', showMessageForm);
            document.getElementById('closeFormBtn').addEventListener('click', hideMessageForm);
            document.getElementById('cancelMessageBtn').addEventListener('click', hideMessageForm);
            document.getElementById('sendMessageForm').addEventListener('submit', sendMessage);
            document.getElementById('refreshBtn').addEventListener('click', refreshMessages);
            document.getElementById('markAllReadBtn').addEventListener('click', markAllAsRead);
            document.getElementById('messageContent').addEventListener('input', updateCharCount);

            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    switchTab(this.dataset.tab);
                });
            });
        });

        // Initialize page based on user role
        function initializePage() {
            document.getElementById('userName').textContent = userData.full_name;
            
            // Set role-specific content
            if (userRole === 'student') {
                document.getElementById('userRole').textContent = `Student - ${userData.community}`;
                document.getElementById('headerSubtitle').textContent = 'Communicate with your coordinator';
                // For students, they send to coordinators
                loadCoordinators();
            } else if (userRole === 'coordinator') {
                document.getElementById('userRole').textContent = `Coordinator - ${userData.assigned_community}`;
                document.getElementById('headerSubtitle').textContent = 'Messages from students and admins';
                // For coordinators, they can send to admins
                loadAdmins();
            } else if (userRole === 'admin' || userRole === 'super_user') {
                document.getElementById('userRole').textContent = 'Administrator';
                document.getElementById('headerSubtitle').textContent = 'System-wide messaging';
                // Admins can message anyone
                loadAllUsers();
            }
        }

        // Load coordinators (for students)
        async function loadCoordinators() {
            const recipientSelect = document.getElementById('recipient');
            recipientSelect.innerHTML = '<option value="">-- Select Coordinator --</option>';
            
            // In a real system, load from API
            recipientSelect.innerHTML += '<option value="1">Coordinator - ' + userData.community + '</option>';
        }

        // Load admins (for coordinators)
        async function loadAdmins() {
            const recipientSelect = document.getElementById('recipient');
            recipientSelect.innerHTML = '<option value="">-- Select Admin --</option>';
            recipientSelect.innerHTML += '<option value="1">System Admin</option>';
        }

        // Load all users (for admins)
        async function loadAllUsers() {
            const recipientSelect = document.getElementById('recipient');
            recipientSelect.innerHTML = '<option value="">-- Select Recipient --</option>';
            recipientSelect.innerHTML += '<option value="coordinator">All Coordinators</option>';
            recipientSelect.innerHTML += '<option value="student">All Students</option>';
        }

        // Load messages
        async function loadMessages() {
            await loadReceivedMessages();
            await loadSentMessages();
        }

        // Load received messages
        async function loadReceivedMessages() {
            try {
                const response = await fetch(`http://localhost:8080/DCROP/backend/api/messages.php?action=received&user_id=${userData.id}&user_role=${userRole}`);
                const result = await response.json();

                const container = document.getElementById('receivedMessagesList');

                if (result.success && result.messages.length > 0) {
                    container.innerHTML = result.messages.map(msg => createMessageCard(msg, 'received')).join('');
                    document.getElementById('totalMessages').textContent = result.count;
                    
                    const unread = result.messages.filter(m => !m.is_read).length;
                    document.getElementById('unreadMessages').textContent = unread;
                } else {
                    container.innerHTML = '<div class="empty-state"><div class="empty-icon">üì≠</div><h3>No Messages</h3><p>You haven\'t received any messages yet.</p></div>';
                }
            } catch (error) {
                console.error('Error loading received messages:', error);
                showError('Failed to load messages');
            }
        }

        // Load sent messages
        async function loadSentMessages() {
            try {
                const response = await fetch(`http://localhost:8080/DCROP/backend/api/messages.php?action=sent&user_id=${userData.id}&user_role=${userRole}`);
                const result = await response.json();

                const container = document.getElementById('sentMessagesList');

                if (result.success && result.messages.length > 0) {
                    container.innerHTML = result.messages.map(msg => createMessageCard(msg, 'sent')).join('');
                } else {
                    container.innerHTML = '<div class="empty-state"><div class="empty-icon">üì§</div><h3>No Sent Messages</h3><p>You haven\'t sent any messages yet.</p></div>';
                }
            } catch (error) {
                console.error('Error loading sent messages:', error);
            }
        }

        // Create message card HTML
        function createMessageCard(message, type) {
            const isReceived = type === 'received';
            const displayName = isReceived ? message.sender_name : message.receiver_name;
            const displayRole = isReceived ? message.sender_role : message.receiver_role;
            const timeAgo = getTimeAgo(message.created_at);
            const readStatus = message.is_read ? '‚úì Read' : '‚Ä¢ Unread';
            const readClass = message.is_read ? 'read' : 'unread';

            return `
                <div class="message-card ${readClass}" data-message-id="${message.id}">
                    <div class="message-header">
                        <div class="sender-info">
                            <span class="sender-icon">üë§</span>
                            <div class="sender-details">
                                <h4 class="sender-name">${displayName || 'Unknown'}</h4>
                                <p class="sender-role">${displayRole}</p>
                            </div>
                        </div>
                        <div class="message-meta">
                            <span class="message-time">${timeAgo}</span>
                            ${isReceived ? `<span class="message-status status-${readClass}">${readStatus}</span>` : ''}
                        </div>
                    </div>
                    <div class="message-body">
                        <p class="message-text">${message.message}</p>
                    </div>
                    <div class="message-actions">
                        ${isReceived && !message.is_read ? 
                            `<button class="btn-sm btn-primary" onclick="markAsRead(${message.id})">‚úì Mark as Read</button>` : 
                            ''}
                        <button class="btn-sm btn-danger" onclick="deleteMessage(${message.id})">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `;
        }

        // Get time ago format
        function getTimeAgo(timestamp) {
            const now = new Date();
            const messageTime = new Date(timestamp);
            const diffMs = now - messageTime;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            return messageTime.toLocaleDateString();
        }

        // Show message form
        function showMessageForm() {
            document.getElementById('newMessageForm').classList.remove('hidden');
            document.getElementById('messageContent').focus();
        }

        // Hide message form
        function hideMessageForm() {
            document.getElementById('newMessageForm').classList.add('hidden');
            document.getElementById('sendMessageForm').reset();
            document.getElementById('charCount').textContent = '0';
        }

        // Send message
        async function sendMessage(e) {
            e.preventDefault();

            const form = e.target;
            const submitBtn = form.querySelector('button[type="submit"]');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoader = submitBtn.querySelector('.btn-loader');

            const recipient = document.getElementById('recipient').value;
            const message = document.getElementById('messageContent').value;

            if (!recipient || !message) {
                alert('Please select a recipient and enter a message');
                return;
            }

            // Show loading
            submitBtn.disabled = true;
            btnText.classList.add('hidden');
            btnLoader.classList.remove('hidden');

            try {
                let endpoint = '';
                let body = {};

                if (userRole === 'student') {
                    endpoint = 'send_to_coordinator';
                    body = {
                        student_id: userData.id,
                        coordinator_id: recipient,
                        message: message
                    };
                } else if (userRole === 'coordinator') {
                    endpoint = 'escalate';
                    body = {
                        coordinator_id: userData.id,
                        admin_id: recipient,
                        message: message
                    };
                } else {
                    endpoint = 'send';
                    body = {
                        sender_id: userData.id,
                        receiver_id: recipient,
                        sender_role: userRole,
                        receiver_role: 'coordinator',
                        message: message
                    };
                }

                const response = await fetch(`http://localhost:8080/DCROP/backend/api/messages.php?action=${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                const result = await response.json();

                if (result.success) {
                    alert('Message sent successfully!');
                    hideMessageForm();
                    loadMessages();
                } else {
                    alert('Failed to send message: ' + result.message);
                }
            } catch (error) {
                console.error('Send message error:', error);
                alert('Connection error. Please try again.');
            } finally {
                submitBtn.disabled = false;
                btnText.classList.remove('hidden');
                btnLoader.classList.add('hidden');
            }
        }

        // Mark as read
        async function markAsRead(messageId) {
            try {
                const response = await fetch('http://localhost:8080/DCROP/backend/api/messages.php?action=mark_read', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message_id: messageId })
                });

                const result = await response.json();
                if (result.success) {
                    loadMessages();
                }
            } catch (error) {
                console.error('Mark as read error:', error);
            }
        }

        // Mark all as read
        async function markAllAsRead() {
            if (!confirm('Mark all messages as read?')) return;

            try {
                const response = await fetch('http://localhost:8080/DCROP/backend/api/messages.php?action=mark_all_read', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        user_id: userData.id,
                        user_role: userRole
                    })
                });

                const result = await response.json();
                if (result.success) {
                    loadMessages();
                }
            } catch (error) {
                console.error('Mark all as read error:', error);
            }
        }

        // Delete message
        async function deleteMessage(messageId) {
            if (!confirm('Are you sure you want to delete this message?')) return;

            try {
                const response = await fetch(`http://localhost:8080/DCROP/backend/api/messages.php?action=delete&message_id=${messageId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.success) {
                    loadMessages();
                }
            } catch (error) {
                console.error('Delete message error:', error);
            }
        }

        // Refresh messages
        function refreshMessages() {
            loadMessages();
        }

        // Switch tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}Tab`).classList.add('active');
        }

        // Update character count
        function updateCharCount(e) {
            const count = e.target.value.length;
            document.getElementById('charCount').textContent = count;
        }

        // Go back
        function goBack() {
            const dashboardMap = {
                'student': 'student.html',
                'coordinator': 'coordinator.html',
                'admin': 'admin.html',
                'super_user': 'superuser.html'
            };
            window.location.href = `../dashboard/${dashboardMap[userRole]}`;
        }

        // Show error
        function showError(message) {
            alert(message);
        }
    </script>
</body>
</html>